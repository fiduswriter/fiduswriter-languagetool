name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install dependencies
        run: |
          pip install pip --upgrade
          if grep version pyproject.toml | grep -q "dev";
            then pip install https://github.com/fiduswriter/fiduswriter/archive/develop.zip;
            else pip install https://github.com/fiduswriter/fiduswriter/archive/main.zip;
          fi
      - uses: pre-commit/action@v3.0.1
  test:
    runs-on: ubuntu-latest
    env:
      LANGUAGETOOL_VERSION: 6.5
    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - uses: actions/checkout@v4
    - uses: nanasess/setup-chromedriver@master
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install libjpeg-dev python3-dev python3-pip gettext zlib1g-dev git nodejs build-essential openjdk-11-jre
        wget https://languagetool.org/download/LanguageTool-${LANGUAGETOOL_VERSION}.zip
        unzip LanguageTool-${LANGUAGETOOL_VERSION}.zip
        if grep version pyproject.toml | grep -q "dev";
          then pip install https://github.com/fiduswriter/fiduswriter/archive/develop.zip;
          else pip install https://github.com/fiduswriter/fiduswriter/archive/main.zip;
        fi
        pip install requests[security]
        pip install coverage
        pip install coveralls
        pip install packaging
        pip install webdriver-manager
        pip install selenium
        pip install wheel
        pip install pip --upgrade
        cd fiduswriter
        mv ../ci/configuration.py ./
        mv ../ci/.coveragerc ./
        coverage run $(which fiduswriter) setup --no-static
    - name: Run test languagetool
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 8
        max_attempts: 3
        retry_on: error
        command: |
          cd LanguageTool-${LANGUAGETOOL_VERSION}
          java -cp languagetool-server.jar org.languagetool.server.HTTPServer --port 9000 &
          cd ../fiduswriter
          coverage run $(which fiduswriter) test languagetool
    - name: Coveralls
      run: |
          cd fiduswriter
          coverage combine
          coveralls --service=github
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
